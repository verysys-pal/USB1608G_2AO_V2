ğŸ“ tree of iocBoot/
./iocBoot
â”œâ”€â”€ Makefile
â””â”€â”€ iocUSB1608G_2AO_V2
    â”œâ”€â”€ Log_stCmd.log
    â”œâ”€â”€ Makefile
    â”œâ”€â”€ README_ThresholdLogic.md
    â”œâ”€â”€ auto_settings.req
    â”œâ”€â”€ autosave
    â”‚Â Â  â”œâ”€â”€ auto_settings.sav
    â”‚Â Â  â”œâ”€â”€ auto_settings.sav0
    â”‚Â Â  â”œâ”€â”€ auto_settings.sav1
    â”‚Â Â  â”œâ”€â”€ auto_settings.sav2
    â”‚Â Â  â””â”€â”€ auto_settings.savB
    â”œâ”€â”€ catest_ThresholdLogic.sh
    â”œâ”€â”€ catest_USB1608G_2AO.sh
    â”œâ”€â”€ cleanup_USB1608G_2AO.sh
    â”œâ”€â”€ envPaths
    â”œâ”€â”€ medm_USB1608G_2AO.sh
    â”œâ”€â”€ save_restore.cmd
    â””â”€â”€ st.cmd

2 directories, 17 files










ğŸ“„ All files under iocBoot/:
./iocBoot/Makefile
./iocBoot/iocUSB1608G_2AO_V2/Log_stCmd.log
./iocBoot/iocUSB1608G_2AO_V2/Makefile
./iocBoot/iocUSB1608G_2AO_V2/README_ThresholdLogic.md
./iocBoot/iocUSB1608G_2AO_V2/auto_settings.req
./iocBoot/iocUSB1608G_2AO_V2/autosave/auto_settings.sav
./iocBoot/iocUSB1608G_2AO_V2/autosave/auto_settings.sav0
./iocBoot/iocUSB1608G_2AO_V2/autosave/auto_settings.sav1
./iocBoot/iocUSB1608G_2AO_V2/autosave/auto_settings.sav2
./iocBoot/iocUSB1608G_2AO_V2/autosave/auto_settings.savB
./iocBoot/iocUSB1608G_2AO_V2/catest_ThresholdLogic.sh
./iocBoot/iocUSB1608G_2AO_V2/catest_USB1608G_2AO.sh
./iocBoot/iocUSB1608G_2AO_V2/cleanup_USB1608G_2AO.sh
./iocBoot/iocUSB1608G_2AO_V2/envPaths
./iocBoot/iocUSB1608G_2AO_V2/medm_USB1608G_2AO.sh
./iocBoot/iocUSB1608G_2AO_V2/save_restore.cmd
./iocBoot/iocUSB1608G_2AO_V2/st.cmd










ğŸ“„ Contents of files under iocBoot/:











ğŸ”¥ File: ./iocBoot/Makefile
=================================================
TOP = ..
include $(TOP)/configure/CONFIG
DIRS += $(wildcard *ioc*)
DIRS += $(wildcard as*)
include $(CONFIG)/RULES_DIRS












ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/Log_stCmd.log
=================================================
#!../../bin/linux-x86_64/USB1608G_2AO_V2
< envPaths
epicsEnvSet("IOC","iocUSB1608G_2AO_V2")
epicsEnvSet("TOP","/usr/local/epics/EPICS_R7.0/siteApp/USB1608G_2AO_V2")
epicsEnvSet("EPICS_BASE","/usr/local/epics/EPICS_R7.0/base")
epicsEnvSet("SUPPORT","/usr/local/epics/EPICS_R7.0/modules/synApps/support")
epicsEnvSet("ASYN","/usr/local/epics/EPICS_R7.0/modules/synApps/support/asyn-R4-44-2")
epicsEnvSet("CALC","/usr/local/epics/EPICS_R7.0/modules/synApps/support/calc-R3-7-5")
epicsEnvSet("SCALER","/usr/local/epics/EPICS_R7.0/modules/synApps/support/scaler-4-1")
epicsEnvSet("MCA","/usr/local/epics/EPICS_R7.0/modules/synApps/support/mca-R7-10")
epicsEnvSet("BUSY","/usr/local/epics/EPICS_R7.0/modules/synApps/support/busy-R1-7-4")
epicsEnvSet("SSCAN","/usr/local/epics/EPICS_R7.0/modules/synApps/support/sscan-R2-11-6")
epicsEnvSet("AUTOSAVE","/usr/local/epics/EPICS_R7.0/modules/synApps/support/autosave-R5-11")
epicsEnvSet("SNCSEQ","/usr/local/epics/EPICS_R7.0/modules/synApps/support/sequencer-mirror-R2-2-9")
epicsEnvSet("MEASCOMP","/usr/local/epics/EPICS_R7.0/modules/synApps/support/measComp-R4-2")
## Register all support components
dbLoadDatabase("/usr/local/epics/EPICS_R7.0/siteApp/USB1608G_2AO_V2/dbd/USB1608G_2AO_V2.dbd")
USB1608G_2AO_V2_registerRecordDeviceDriver(pdbbase)
ThresholdLogicRegister: IOC ì‰˜ ëª…ë ¹ì–´ ë“±ë¡ ì™„ë£Œ
  - ThresholdLogicConfig: ì„ê³„ê°’ ë¡œì§ ì»¨íŠ¸ë¡¤ëŸ¬ ìƒì„±
  - ThresholdLogicHelp: ì‚¬ìš©ë²• ë„ì›€ë§ í‘œì‹œ
ë„ì›€ë§ì„ ë³´ë ¤ë©´ 'ThresholdLogicHelp'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
## Environment variable setup
epicsEnvSet("PREFIX", "USB1608G_2AO:")
epicsEnvSet("PORT", "USB1608G_2AO_PORT")
epicsEnvSet("WDIG_POINTS", "1048576")
epicsEnvSet("WGEN_POINTS", "1048576")
epicsEnvSet("UNIQUE_ID", "01D97CFA")
## Configure port driver
MultiFunctionConfig("USB1608G_2AO_PORT", "01D97CFA", 1048576, 1048576)
## Configure threshold logic controller
epicsEnvSet("THRESHOLD_PORT", "THRESHOLD_LOGIC_PORT")
ThresholdLogicConfig("THRESHOLD_LOGIC_PORT", "USB1608G_2AO_PORT", 0)
[2025-08-30 15:17:31.899114] [ê²½ê³ ] validateConfigurationWithErrorHandler: íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ê°€ ì„ê³„ê°’ë³´ë‹¤ í½ë‹ˆë‹¤
[2025-08-30 15:17:31.899126] [ì •ë³´] validateConfigurationWithErrorHandler: íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ë¥¼ ì„ê³„ê°’ ì ˆëŒ“ê°’ë³´ë‹¤ ì‘ê²Œ ì„¤ì •í•˜ì„¸ìš”
[2025-08-30 15:17:31.899129] [ì •ë³´] ThresholdLogicController: í¬íŠ¸=THRESHOLD_LOGIC_PORT, ì¥ì¹˜í¬íŠ¸=USB1608G_2AO_PORT, ì£¼ì†Œ=0ë¡œ ThresholdLogicController ìƒì„±ë¨
ThresholdLogicConfig: ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë¨ - í¬íŠ¸: THRESHOLD_LOGIC_PORT, ì¥ì¹˜í¬íŠ¸: USB1608G_2AO_PORT, ì£¼ì†Œ: 0
## Load database templates
dbLoadTemplate("/usr/local/epics/EPICS_R7.0/siteApp/USB1608G_2AO_V2/USB1608G_2AO_V2App/Db/USB1608G_2AO.substitutions", "P=USB1608G_2AO:,PORT=USB1608G_2AO_PORT,WDIG_POINTS=1048576,WGEN_POINTS=1048576")
## Load save/restore configuration
< save_restore.cmd
# Debug-output level
save_restoreSet_Debug(0)
# Ok to save/restore save sets with missing values (no CA connection to PV)?
save_restoreSet_IncompleteSetsOk(1)
# Save dated backup files?
save_restoreSet_DatedBackupFiles(1)
# Number of sequenced backup files to write
save_restoreSet_NumSeqFiles(3)
# Time interval between sequenced backups
save_restoreSet_SeqPeriodInSeconds(300)
# specify where save files should be
set_savefile_path(".", "autosave")
# specify what save files should be restored.  Note these files must be
# in the directory specified in set_savefile_path(), or, if that function
# has not been called, from the directory current when iocInit is invoked0
set_pass0_restoreFile("auto_settings.sav")
set_pass1_restoreFile("auto_settings.sav")
# specify directories in which to to search for included request files
# Note cdCommands defines 'startup', but envPaths does not
set_requestfile_path(".",         "")
set_requestfile_path(".",         "autosave")
set_requestfile_path(/usr/local/epics/EPICS_R7.0/modules/synApps/support/autosave-R5-11, "db")
set_requestfile_path(/usr/local/epics/EPICS_R7.0/modules/synApps/support/calc-R3-7-5,     "db")
set_requestfile_path(/usr/local/epics/EPICS_R7.0/modules/synApps/support/scaler-4-1,   "db")
set_requestfile_path(/usr/local/epics/EPICS_R7.0/modules/synApps/support/sscan-R2-11-6,    "db")
set_requestfile_path(/usr/local/epics/EPICS_R7.0/modules/synApps/support/measComp-R4-2, "db")
## Initialize IOC
iocInit
############################################################################
## EPICS R7.0.7
## Rev. 2025-08-12T12:26+0900
## Rev. Date build date/time: 
############################################################################
save_restore: **********************************

USB1608G_2AO:ThresholdLogic1Threshold devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic1Hysteresis devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic1UpdateRate devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic2Threshold devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic2Hysteresis devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic2UpdateRate devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic3Threshold devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic3Hysteresis devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic3UpdateRate devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic4Threshold devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic4Hysteresis devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic4UpdateRate devAsynFloat64::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic1AlarmState devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic2AlarmState devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic3AlarmState devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic4AlarmState devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic1Enable devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic1Reset devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic2Enable devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic2Reset devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic3Enable devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic3Reset devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic4Enable devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic4Reset devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic1TriggerCount devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic2TriggerCount devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic3TriggerCount devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic4TriggerCount devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic1Status devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic2Status devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic3Status devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic4Status devAsynInt32::initCommon drvUserCreate 
USB1608G_2AO:ThresholdLogic1LastUpdate devAsynOctet::initDrvUser drvUserCreate failed 
USB1608G_2AO:ThresholdLogic2LastUpdate devAsynOctet::initDrvUser drvUserCreate failed 
USB1608G_2AO:ThresholdLogic3LastUpdate devAsynOctet::initDrvUser drvUserCreate failed 
USB1608G_2AO:ThresholdLogic4LastUpdate devAsynOctet::initDrvUser drvUserCreate failed 
save_restore: **********************************

## Setup autosave monitoring
create_monitor_set("auto_settings.req",30,"P=USB1608G_2AO:")
save_restore: connect failed for channel 'file'
save_restore: connect failed for channel 'file'
auto_settings.sav: 0 of 2 PV's connected
[?2004hepics> 
[?2004l[?2004hepics> 
[?2004l[?2004hepics> 
[?2004l[?2004hepics> dbl
[?2004lUSB1608G_2AO:PollTimeMS
USB1608G_2AO:PulseGen1Period_RBV
USB1608G_2AO:PulseGen1DutyCycle_RBV
USB1608G_2AO:PulseGen1Delay_RBV
USB1608G_2AO:Ai1
USB1608G_2AO:Ai2
USB1608G_2AO:Ai3
USB1608G_2AO:Ai4
USB1608G_2AO:Ai5
USB1608G_2AO:Ai6
USB1608G_2AO:Ai7
USB1608G_2AO:Ai8
USB1608G_2AO:WaveDigDwellActual
USB1608G_2AO:WaveDigTotalTime
USB1608G_2AO:WaveGenFrequency
USB1608G_2AO:WaveGenDwell
USB1608G_2AO:WaveGenDwellActual
USB1608G_2AO:WaveGenTotalTime
USB1608G_2AO:ThresholdLogic1CurrentValue
USB1608G_2AO:ThresholdLogic2CurrentValue
USB1608G_2AO:ThresholdLogic3CurrentValue
USB1608G_2AO:ThresholdLogic4CurrentValue
USB1608G_2AO:PollSleepMS
USB1608G_2AO:PulseGen1Period
USB1608G_2AO:PulseGen1Frequency
USB1608G_2AO:PulseGen1DutyCycle
USB1608G_2AO:PulseGen1Width
USB1608G_2AO:PulseGen1Delay
USB1608G_2AO:Ai1Rate
USB1608G_2AO:Ai2Rate
USB1608G_2AO:Ai3Rate
USB1608G_2AO:Ai4Rate
USB1608G_2AO:Ai5Rate
USB1608G_2AO:Ai6Rate
USB1608G_2AO:Ai7Rate
USB1608G_2AO:Ai8Rate
USB1608G_2AO:WaveDigDwell
USB1608G_2AO:Ao1
USB1608G_2AO:Ao1Return
USB1608G_2AO:Ao1TweakVal
USB1608G_2AO:Ao2
USB1608G_2AO:Ao2Return
USB1608G_2AO:Ao2TweakVal
USB1608G_2AO:WaveGenIntDwell
USB1608G_2AO:WaveGenIntFrequency
USB1608G_2AO:WaveGenUserDwell
USB1608G_2AO:WaveGenUserFrequency
USB1608G_2AO:WaveGen1PulseWidth
USB1608G_2AO:WaveGen1Amplitude
USB1608G_2AO:WaveGen1Offset
USB1608G_2AO:WaveGen2PulseWidth
USB1608G_2AO:WaveGen2Amplitude
USB1608G_2AO:WaveGen2Offset
USB1608G_2AO:ThresholdLogic1Threshold
USB1608G_2AO:ThresholdLogic1Hysteresis
USB1608G_2AO:ThresholdLogic1UpdateRate
USB1608G_2AO:ThresholdLogic2Threshold
USB1608G_2AO:ThresholdLogic2Hysteresis
USB1608G_2AO:ThresholdLogic2UpdateRate
USB1608G_2AO:ThresholdLogic3Threshold
USB1608G_2AO:ThresholdLogic3Hysteresis
USB1608G_2AO:ThresholdLogic3UpdateRate
USB1608G_2AO:ThresholdLogic4Threshold
USB1608G_2AO:ThresholdLogic4Hysteresis
USB1608G_2AO:ThresholdLogic4UpdateRate
USB1608G_2AO:Bi1
USB1608G_2AO:Bi2
USB1608G_2AO:Bi3
USB1608G_2AO:Bi4
USB1608G_2AO:Bi5
USB1608G_2AO:Bi6
USB1608G_2AO:Bi7
USB1608G_2AO:Bi8
USB1608G_2AO:Bo1_RBV
USB1608G_2AO:Bo2_RBV
USB1608G_2AO:Bo3_RBV
USB1608G_2AO:Bo4_RBV
USB1608G_2AO:Bo5_RBV
USB1608G_2AO:Bo6_RBV
USB1608G_2AO:Bo7_RBV
USB1608G_2AO:Bo8_RBV
USB1608G_2AO:ThresholdLogic1OutputState
USB1608G_2AO:ThresholdLogic1AlarmState
USB1608G_2AO:ThresholdLogic2OutputState
USB1608G_2AO:ThresholdLogic2AlarmState
USB1608G_2AO:ThresholdLogic3OutputState
USB1608G_2AO:ThresholdLogic3AlarmState
USB1608G_2AO:ThresholdLogic4OutputState
USB1608G_2AO:ThresholdLogic4AlarmState
USB1608G_2AO:Bo1
USB1608G_2AO:Bo2
USB1608G_2AO:Bo3
USB1608G_2AO:Bo4
USB1608G_2AO:Bo5
USB1608G_2AO:Bo6
USB1608G_2AO:Bo7
USB1608G_2AO:Bo8
USB1608G_2AO:Bd1
USB1608G_2AO:Bd2
USB1608G_2AO:Bd3
USB1608G_2AO:Bd4
USB1608G_2AO:Bd5
USB1608G_2AO:Bd6
USB1608G_2AO:Bd7
USB1608G_2AO:Bd8
USB1608G_2AO:PulseGen1Run
USB1608G_2AO:PulseGen1IdleState
USB1608G_2AO:Counter1Reset
USB1608G_2AO:Counter2Reset
USB1608G_2AO:WaveDigExtTrigger
USB1608G_2AO:WaveDigExtClock
USB1608G_2AO:WaveDigContinuous
USB1608G_2AO:WaveDigAutoRestart
USB1608G_2AO:WaveDigRetrigger
USB1608G_2AO:WaveDigBurstMode
USB1608G_2AO:Ao1Pulse
USB1608G_2AO:Ao2Pulse
USB1608G_2AO:WaveGenExtTrigger
USB1608G_2AO:WaveGenExtClock
USB1608G_2AO:WaveGenContinuous
USB1608G_2AO:WaveGenRetrigger
USB1608G_2AO:WaveGen1Enable
USB1608G_2AO:WaveGen2Enable
USB1608G_2AO:ThresholdLogic1Enable
USB1608G_2AO:ThresholdLogic1Reset
USB1608G_2AO:ThresholdLogic2Enable
USB1608G_2AO:ThresholdLogic2Reset
USB1608G_2AO:ThresholdLogic3Enable
USB1608G_2AO:ThresholdLogic3Reset
USB1608G_2AO:ThresholdLogic4Enable
USB1608G_2AO:ThresholdLogic4Reset
USB1608G_2AO:WaveDigRun
USB1608G_2AO:WaveDigReadWF
USB1608G_2AO:WaveGenRun
USB1608G_2AO:PulseGen1Frequency_RBV
USB1608G_2AO:PulseGen1Width_RBV
USB1608G_2AO:PulseGen1CalcFrequency
USB1608G_2AO:PulseGen1CalcPeriod
USB1608G_2AO:PulseGen1CalcWidth
USB1608G_2AO:PulseGen1CalcDutyCycle
USB1608G_2AO:Ao1TweakUp
USB1608G_2AO:Ao1TweakDown
USB1608G_2AO:Ao2TweakUp
USB1608G_2AO:Ao2TweakDown
USB1608G_2AO:WaveGenCalcIntFrequency
USB1608G_2AO:WaveGenCalcIntDwell
USB1608G_2AO:WaveGenCalcUserFrequency
USB1608G_2AO:WaveGenCalcUserDwell
USB1608G_2AO:ThresholdLogic1Compare
USB1608G_2AO:ThresholdLogic2Compare
USB1608G_2AO:ThresholdLogic3Compare
USB1608G_2AO:ThresholdLogic4Compare
USB1608G_2AO:ModelNumber
USB1608G_2AO:Li
USB1608G_2AO:Lo_RBV
USB1608G_2AO:Counter1Counts
USB1608G_2AO:Counter2Counts
USB1608G_2AO:WaveDigCurrentPoint
USB1608G_2AO:WaveGenNumPoints
USB1608G_2AO:WaveGenCurrentPoint
USB1608G_2AO:ThresholdLogic1TriggerCount
USB1608G_2AO:ThresholdLogic2TriggerCount
USB1608G_2AO:ThresholdLogic3TriggerCount
USB1608G_2AO:ThresholdLogic4TriggerCount
USB1608G_2AO:Lo
USB1608G_2AO:PulseGen1Count
USB1608G_2AO:WaveDigNumPoints
USB1608G_2AO:WaveDigTriggerCount
USB1608G_2AO:WaveGenUserNumPoints
USB1608G_2AO:WaveGenIntNumPoints
USB1608G_2AO:WaveGenTriggerCount
USB1608G_2AO:ThresholdLogic1Status
USB1608G_2AO:ThresholdLogic2Status
USB1608G_2AO:ThresholdLogic3Status
USB1608G_2AO:ThresholdLogic4Status
USB1608G_2AO:AiMode
USB1608G_2AO:Ai1Range
USB1608G_2AO:Ai1Type
USB1608G_2AO:Ai2Range
USB1608G_2AO:Ai2Type
USB1608G_2AO:Ai3Range
USB1608G_2AO:Ai3Type
USB1608G_2AO:Ai4Range
USB1608G_2AO:Ai4Type
USB1608G_2AO:Ai5Range
USB1608G_2AO:Ai5Type
USB1608G_2AO:Ai6Range
USB1608G_2AO:Ai6Type
USB1608G_2AO:Ai7Range
USB1608G_2AO:Ai7Type
USB1608G_2AO:Ai8Range
USB1608G_2AO:Ai8Type
USB1608G_2AO:WaveDigFirstChan
USB1608G_2AO:WaveDigNumChans
USB1608G_2AO:Ao1Range
USB1608G_2AO:Ao2Range
USB1608G_2AO:WaveGen1Type
USB1608G_2AO:WaveGen2Type
USB1608G_2AO:TrigMode
USB1608G_2AO:ModelName
USB1608G_2AO:FirmwareVersion
USB1608G_2AO:UniqueID
USB1608G_2AO:ULVersion
USB1608G_2AO:DriverVersion
USB1608G_2AO:ThresholdLogic1LastUpdate
USB1608G_2AO:ThresholdLogic2LastUpdate
USB1608G_2AO:ThresholdLogic3LastUpdate
USB1608G_2AO:ThresholdLogic4LastUpdate
USB1608G_2AO:LastErrorMessage
USB1608G_2AO:WaveDigTimeWF
USB1608G_2AO:WaveDigAbsTimeWF
USB1608G_2AO:WaveDig1VoltWF
USB1608G_2AO:WaveDig2VoltWF
USB1608G_2AO:WaveDig3VoltWF
USB1608G_2AO:WaveDig4VoltWF
USB1608G_2AO:WaveDig5VoltWF
USB1608G_2AO:WaveDig6VoltWF
USB1608G_2AO:WaveDig7VoltWF
USB1608G_2AO:WaveDig8VoltWF
USB1608G_2AO:WaveGenUserTimeWF
USB1608G_2AO:WaveGenIntTimeWF
USB1608G_2AO:WaveGen1UserWF
USB1608G_2AO:WaveGen1InternalWF
USB1608G_2AO:WaveGen2UserWF
USB1608G_2AO:WaveGen2InternalWF
[?2004hepics> 
[?2004l[?2004hepics> 
[?2004l[?2004hepics> 
[?2004l[?2004hepics> save_restore:write_save_file: Backup file (./autosave/auto_settings.savB) bad or not found.  Writing a new one. [250830-151833]
[Kepics> [Kepics> [Kepics> [?2004l










ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/Makefile
=================================================
TOP = ../..
include $(TOP)/configure/CONFIG
ARCH = $(EPICS_HOST_ARCH)
TARGETS = envPaths
include $(TOP)/configure/RULES.ioc











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/README_ThresholdLogic.md
=================================================
# ThresholdLogic Controller MEDM ë° í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ê°œìš”

ì´ ë¬¸ì„œëŠ” USB1608G-2AO IOCì— ì¶”ê°€ëœ ThresholdLogicControllerì˜ MEDM í™”ë©´ê³¼ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

## íŒŒì¼ êµ¬ì„±

### MEDM í™”ë©´
- `USB1608G_2AO_cpp.adl` - ê¸°ì¡´ í™”ë©´ì— ThresholdLogic ì„¹ì…˜ ì¶”ê°€
- `medm_ThresholdLogic.sh` - ThresholdLogic ì „ìš© MEDM ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
- `medm_USB1608G_2AO.sh` - ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ì— ThresholdLogic ì˜µì…˜ ì¶”ê°€

### í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
- `catest_ThresholdLogic.sh` - í¬ê´„ì ì¸ ThresholdLogic í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
- `catest_USB1608G_2AO.sh` - ê¸°ì¡´ USB1608G-2AO í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

## MEDM í™”ë©´ ì‚¬ìš©ë²•

### 1. ì „ì²´ ì‹œìŠ¤í…œ MEDM í™”ë©´ ì‹¤í–‰

```bash
# ë°©ë²• 1: ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ë©”ë‰´ì—ì„œ ì„ íƒ)
./medm_USB1608G_2AO.sh
# ë©”ë‰´ì—ì„œ 1ë²ˆ ë˜ëŠ” 2ë²ˆ ì„ íƒ

# ë°©ë²• 2: ì§ì ‘ ì‹¤í–‰
./medm_ThresholdLogic.sh
```

### 2. MEDM í™”ë©´ êµ¬ì„±

#### ê¸°ì¡´ ì„¹ì…˜ (ìƒë‹¨)
- **ì¥ì¹˜ ì •ë³´**: ëª¨ë¸ëª…, ê³ ìœ  ID, ë“œë¼ì´ë²„ ë²„ì „
- **ë””ì§€í„¸ I/O**: 8ì±„ë„ ë””ì§€í„¸ ì…ì¶œë ¥ ì œì–´
- **ì•„ë‚ ë¡œê·¸ ì…ë ¥**: 8ì±„ë„ ì•„ë‚ ë¡œê·¸ ì…ë ¥ ëª¨ë‹ˆí„°ë§
- **ì•„ë‚ ë¡œê·¸ ì¶œë ¥**: 2ì±„ë„ ì•„ë‚ ë¡œê·¸ ì¶œë ¥ ì œì–´
- **íŠ¸ë Œë“œ ì°¨íŠ¸**: ì‹¤ì‹œê°„ ë°ì´í„° ì‹œê°í™”

#### ìƒˆë¡œ ì¶”ê°€ëœ ThresholdLogic ì„¹ì…˜ (í•˜ë‹¨)

**ì„¤ì • ì»¨íŠ¸ë¡¤ (ì¢Œì¸¡)**:
- **Threshold**: ì„ê³„ê°’ ì„¤ì • (V ë‹¨ìœ„)
- **Hysteresis**: íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ ê°’ ì„¤ì • (V ë‹¨ìœ„)
- **Update Rate**: ì—…ë°ì´íŠ¸ ì£¼ê¸° ì„¤ì • (Hz ë‹¨ìœ„)
- **Logic Status**: í˜„ì¬ ë¡œì§ ìƒíƒœ í‘œì‹œ
- **Reset**: ì‹œìŠ¤í…œ ë¦¬ì…‹ ë²„íŠ¼

**ìƒíƒœ ëª¨ë‹ˆí„°ë§ (ì¤‘ì•™)**:
- **Current Value**: í˜„ì¬ ì…ë ¥ê°’ ì‹¤ì‹œê°„ í‘œì‹œ
- **Output State**: ì¶œë ¥ ìƒíƒœ (LED í‘œì‹œ)
- **Enable**: ì»¨íŠ¸ë¡¤ëŸ¬ í™œì„±í™”/ë¹„í™œì„±í™” ë²„íŠ¼
- **Alarm Status**: ì•ŒëŒ ìƒíƒœ í‘œì‹œ

**ì‹œê°í™” (ìš°ì¸¡)**:
- **Meter**: í˜„ì¬ê°’ì„ ì•„ë‚ ë¡œê·¸ ë¯¸í„°ë¡œ í‘œì‹œ
- **Trend Chart**: í˜„ì¬ê°’ê³¼ ì„ê³„ê°’ì˜ ì‹œê°„ ì¶”ì´

**ë¡œì§ ì„¤ëª… ë°•ìŠ¤**:
- ì„ê³„ê°’ ë¡œì§ì˜ ë™ì‘ ì›ë¦¬ ì„¤ëª…
- íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ ê¸°ëŠ¥ ì„¤ëª…

### 3. ì‚¬ìš© ì ˆì°¨

1. **IOC ì‹œì‘ í™•ì¸**
   ```bash
   # IOCê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
   ps aux | grep USB1608G_2AO_cpp
   ```

2. **MEDM í™”ë©´ ì‹¤í–‰**
   ```bash
   ./medm_ThresholdLogic.sh
   ```

3. **ThresholdLogic ì„¤ì •**
   - Threshold í•„ë“œì— ì›í•˜ëŠ” ì„ê³„ê°’ ì…ë ¥ (ì˜ˆ: 2.5)
   - Hysteresis í•„ë“œì— íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ ê°’ ì…ë ¥ (ì˜ˆ: 0.1)
   - Update Rate ì„¤ì • (ê¸°ë³¸ê°’: 10Hz)

4. **ì»¨íŠ¸ë¡¤ëŸ¬ í™œì„±í™”**
   - Enable ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ "Enabled"ë¡œ ë³€ê²½

5. **ë™ì‘ í™•ì¸**
   - Current Valueê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ëŠ”ì§€ í™•ì¸
   - ì„ê³„ê°’ì„ ì´ˆê³¼í•˜ë©´ Output Stateê°€ "High"ë¡œ ë³€ê²½ë˜ëŠ”ì§€ í™•ì¸
   - íŠ¸ë Œë“œ ì°¨íŠ¸ì—ì„œ ì‹œê°„ì— ë”°ë¥¸ ë³€í™” ê´€ì°°

## í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©ë²•

### 1. ìë™ ì „ì²´ í…ŒìŠ¤íŠ¸

```bash
# ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰
./catest_ThresholdLogic.sh --auto
```

### 2. ëŒ€í™”í˜• í…ŒìŠ¤íŠ¸

```bash
# ëŒ€í™”í˜• ë©”ë‰´ë¡œ ì‹¤í–‰
./catest_ThresholdLogic.sh
```

ë©”ë‰´ ì˜µì…˜:
1. **ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰** - ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
2. **PV ì—°ê²° í…ŒìŠ¤íŠ¸ë§Œ** - PV ì—°ê²° ìƒíƒœë§Œ í™•ì¸
3. **ì„ê³„ê°’ ë¡œì§ í…ŒìŠ¤íŠ¸ë§Œ** - ì„ê³„ê°’ ë¹„êµ ë¡œì§ë§Œ í…ŒìŠ¤íŠ¸
4. **íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ í…ŒìŠ¤íŠ¸ë§Œ** - íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ ê¸°ëŠ¥ë§Œ í…ŒìŠ¤íŠ¸
5. **ì—°ì† ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸ë§Œ** - ì‚¬ì¸íŒŒ ì…ë ¥ìœ¼ë¡œ ì—°ì† í…ŒìŠ¤íŠ¸
6. **ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§** - ì‹¤ì‹œê°„ PV ê°’ ëª¨ë‹ˆí„°ë§
7. **í˜„ì¬ ìƒíƒœ í™•ì¸** - í˜„ì¬ ì„¤ì • ë° ìƒíƒœ í™•ì¸
8. **ì„¤ì • ì´ˆê¸°í™”** - ëª¨ë“  ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
9. **ì¢…ë£Œ** - ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ

### 3. í…ŒìŠ¤íŠ¸ ë‚´ìš©

#### PV ì—°ê²° í…ŒìŠ¤íŠ¸
- ëª¨ë“  ThresholdLogic PVì˜ ì—°ê²° ìƒíƒœ í™•ì¸
- IOC ì‹¤í–‰ ìƒíƒœ ê²€ì¦

#### ì„ê³„ê°’ ë¡œì§ í…ŒìŠ¤íŠ¸
- ë‹¤ì–‘í•œ ì…ë ¥ ì „ì••ì— ëŒ€í•œ ì¶œë ¥ ìƒíƒœ í™•ì¸
- ì„ê³„ê°’ ì´ˆê³¼/ë¯¸ë§Œ ì‹œ ë™ì‘ ê²€ì¦
- ë¡œì§ ì •í™•ì„± ê²€ì¦

#### íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ í…ŒìŠ¤íŠ¸
- íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ ê¸°ëŠ¥ ë™ì‘ í™•ì¸
- ì¶œë ¥ ì§„ë™ ë°©ì§€ ê¸°ëŠ¥ ê²€ì¦
- ìƒí–¥/í•˜í–¥ ì„ê³„ê°’ ë™ì‘ í™•ì¸

#### ì—°ì† ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸
- ì‚¬ì¸íŒŒ ì…ë ¥ìœ¼ë¡œ 30ì´ˆê°„ ì—°ì† í…ŒìŠ¤íŠ¸
- ì¶œë ¥ ìƒíƒœ ë³€í™” íšŸìˆ˜ ì¹´ìš´íŠ¸
- ì‹¤ì‹œê°„ ì‘ë‹µì„± í™•ì¸

#### ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
- ë¹ ë¥¸ ì…ë ¥ ë³€í™”ì— ëŒ€í•œ ì‘ë‹µì„± í…ŒìŠ¤íŠ¸
- ë‹¤ì–‘í•œ ì—…ë°ì´íŠ¸ ì£¼ê¸°ì—ì„œì˜ ë™ì‘ í™•ì¸
- CPU ì‚¬ìš©ë¥  ë° ì•ˆì •ì„± ê²€ì¦

## ë¬¸ì œ í•´ê²°

### 1. MEDM ì‹¤í–‰ ì˜¤ë¥˜

**ì¦ìƒ**: MEDMì´ ì‹œì‘ë˜ì§€ ì•ŠìŒ
```bash
medm: command not found
```

**í•´ê²° ë°©ë²•**:
```bash
# MEDM ì„¤ì¹˜ í™•ì¸
which medm

# EPICS Extensions ê²½ë¡œ í™•ì¸
echo $PATH | grep -i medm

# í•„ìš”ì‹œ PATH ì¶”ê°€
export PATH=$PATH:/usr/local/epics/extensions/bin/$EPICS_HOST_ARCH
```

### 2. PV ì—°ê²° ì‹¤íŒ¨

**ì¦ìƒ**: PV ì—°ê²° íƒ€ì„ì•„ì›ƒ
```bash
Channel connect timed out
```

**í•´ê²° ë°©ë²•**:
```bash
# IOC ì‹¤í–‰ ìƒíƒœ í™•ì¸
ps aux | grep USB1608G_2AO_cpp

# IOC ì¬ì‹œì‘
cd iocBoot/iocUSB1608G_2AO_cpp
../../bin/linux-x86_64/USB1608G_2AO_cpp st.cmd

# ë„¤íŠ¸ì›Œí¬ ì„¤ì • í™•ì¸
echo $EPICS_CA_ADDR_LIST
echo $EPICS_CA_AUTO_ADDR_LIST
```

### 3. ThresholdLogic ë™ì‘ ì•ˆí•¨

**ì¦ìƒ**: ì„ê³„ê°’ì„ ì´ˆê³¼í•´ë„ ì¶œë ¥ì´ ë³€ê²½ë˜ì§€ ì•ŠìŒ

**í•´ê²° ë°©ë²•**:
```bash
# ì»¨íŠ¸ë¡¤ëŸ¬ í™œì„±í™” ìƒíƒœ í™•ì¸
caget USB1608G_2AO_cpp:ThresholdLogic1Enable

# í™œì„±í™”
caput USB1608G_2AO_cpp:ThresholdLogic1Enable 1

# í˜„ì¬ê°’ í™•ì¸
caget USB1608G_2AO_cpp:ThresholdLogic1CurrentValue

# ì„ê³„ê°’ í™•ì¸
caget USB1608G_2AO_cpp:ThresholdLogic1Threshold
```

### 4. í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì˜¤ë¥˜

**ì¦ìƒ**: Permission denied

**í•´ê²° ë°©ë²•**:
```bash
# ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
chmod +x catest_ThresholdLogic.sh
chmod +x medm_ThresholdLogic.sh

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
./catest_ThresholdLogic.sh
```

## ê³ ê¸‰ ì‚¬ìš©ë²•

### 1. ì‚¬ìš©ì ì •ì˜ í…ŒìŠ¤íŠ¸

í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆ˜ì •í•˜ì—¬ íŠ¹ì • ìš”êµ¬ì‚¬í•­ì— ë§ëŠ” í…ŒìŠ¤íŠ¸ ì¶”ê°€:

```bash
# ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
cp catest_ThresholdLogic.sh my_custom_test.sh

# ì‚¬ìš©ì ì •ì˜ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ì¶”ê°€
function my_custom_test() {
    print_header "ì‚¬ìš©ì ì •ì˜ í…ŒìŠ¤íŠ¸"
    # ì—¬ê¸°ì— ì‚¬ìš©ì ì •ì˜ í…ŒìŠ¤íŠ¸ ë¡œì§ ì¶”ê°€
}
```

### 2. ìë™í™”ëœ ëª¨ë‹ˆí„°ë§

ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ ìë™í™” ìŠ¤í¬ë¦½íŠ¸:

```bash
# ì£¼ê¸°ì  ìƒíƒœ í™•ì¸
while true; do
    echo "$(date): $(caget -t USB1608G_2AO_cpp:ThresholdLogic1CurrentValue) V"
    sleep 10
done
```

### 3. ë¡œê·¸ ë¶„ì„

í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¡œê·¸ ë¶„ì„:

```bash
# í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ í™•ì¸
cat /tmp/threshold_logic_test_report.txt

# íŠ¹ì • íŒ¨í„´ ê²€ìƒ‰
grep -i "error\|fail" /tmp/threshold_logic_test_report.txt
```

## ì°¸ê³  ìë£Œ

- [EPICS MEDM ì‚¬ìš©ì ê°€ì´ë“œ](https://epics.anl.gov/EpicsDocumentation/ExtensionsManuals/MEDM/MEDM.html)
- [Channel Access í´ë¼ì´ì–¸íŠ¸ ë„êµ¬](https://epics.anl.gov/base/R7-0/8-docs/CAref.html)
- [ThresholdLogicController API ë¬¸ì„œ](../../docs/ThresholdLogicController_API_Documentation.md)
- [ë¬¸ì œ í•´ê²° ê°€ì´ë“œ](../../docs/ThresholdLogicController_Troubleshooting_Guide.md)

## ë²„ì „ ì •ë³´

- ìƒì„±ì¼: 2025ë…„ 8ì›” 20ì¼
- ThresholdLogicController ë²„ì „: 1.0.0
- EPICS Base í˜¸í™˜ì„±: R7.0+
- í…ŒìŠ¤íŠ¸ í™˜ê²½: Linux x86_64










ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/auto_settings.req
=================================================
    file "/usr/local/epics/EPICS_R7.0/siteApp/USB1608G_2AO_V2/USB1608G_2AO_V2App/Db/USB1608G_2AO_settings.req", P=$(P)
    file "/usr/local/epics/EPICS_R7.0/siteApp/USB1608G_2AO_V2/USB1608G_2AO_V2App/Db/threshold_logic_settings.req", P=$(P)











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/autosave/auto_settings.sav
=================================================
# autosave R5.3	Automatically generated - DO NOT MODIFY - 250830-215736
! 2 channel(s) not connected - or not all gets were successful
#file Search Issued
#file Search Issued
<END>











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/autosave/auto_settings.sav0
=================================================
# autosave R5.3	Automatically generated - DO NOT MODIFY - 250830-214735
! 2 channel(s) not connected - or not all gets were successful
#file Search Issued
#file Search Issued
<END>











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/autosave/auto_settings.sav1
=================================================
# autosave R5.3	Automatically generated - DO NOT MODIFY - 250830-215736
! 2 channel(s) not connected - or not all gets were successful
#file Search Issued
#file Search Issued
<END>











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/autosave/auto_settings.sav2
=================================================
# autosave R5.3	Automatically generated - DO NOT MODIFY - 250830-214735
! 2 channel(s) not connected - or not all gets were successful
#file Search Issued
#file Search Issued
<END>











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/autosave/auto_settings.savB
=================================================
# autosave R5.3	Automatically generated - DO NOT MODIFY - 250830-215736
! 2 channel(s) not connected - or not all gets were successful
#file Search Issued
#file Search Issued
<END>











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/catest_ThresholdLogic.sh
=================================================
#!/bin/bash

# ThresholdLogic Controller í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ThresholdLogicControllerì˜ ëª¨ë“  ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

# ===== ìƒ‰ìƒ ì •ì˜ =====
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ===== PV ì´ë¦„ ì •ì˜ =====
PREFIX="USB1608G_2AO:"
CONTROLLER="ThresholdLogic1"

THRESHOLD_PV="${PREFIX}${CONTROLLER}Threshold"
HYSTERESIS_PV="${PREFIX}${CONTROLLER}Hysteresis"
CURRENT_VALUE_PV="${PREFIX}${CONTROLLER}CurrentValue"
OUTPUT_STATE_PV="${PREFIX}${CONTROLLER}OutputState"
ENABLE_PV="${PREFIX}${CONTROLLER}Enable"
UPDATE_RATE_PV="${PREFIX}${CONTROLLER}UpdateRate"
ALARM_STATE_PV="${PREFIX}${CONTROLLER}AlarmState"
RESET_PV="${PREFIX}${CONTROLLER}Reset"

# í…ŒìŠ¤íŠ¸ìš© ì•„ë‚ ë¡œê·¸ ì¶œë ¥ (ì…ë ¥ ì‹œë®¬ë ˆì´ì…˜ìš©)
AO_PV="${PREFIX}Ao1"

# ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====

function print_header() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${CYAN}========================================${NC}"
}

function print_section() {
    echo -e "\n${YELLOW}--- $1 ---${NC}"
}

function print_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

function print_error() {
    echo -e "${RED}âœ— $1${NC}"
}

function print_info() {
    echo -e "${BLUE}â„¹ $1${NC}"
}

function wait_for_user() {
    echo -e "${PURPLE}Press Enter to continue...${NC}"
    read
}

function check_pv_connection() {
    local pv=$1
    local timeout=5
    
    if timeout $timeout caget "$pv" > /dev/null 2>&1; then
        print_success "PV ì—°ê²° ì„±ê³µ: $pv"
        return 0
    else
        print_error "PV ì—°ê²° ì‹¤íŒ¨: $pv"
        return 1
    fi
}

function get_pv_value() {
    local pv=$1
    caget -t "$pv" 2>/dev/null
}

function set_pv_value() {
    local pv=$1
    local value=$2
    caput -t "$pv" "$value" > /dev/null 2>&1
}

function monitor_pvs() {
    local duration=$1
    print_info "ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (${duration}ì´ˆê°„)..."
    timeout "$duration" camonitor "$CURRENT_VALUE_PV" "$OUTPUT_STATE_PV" "$THRESHOLD_PV" 2>/dev/null || true
}

# ===== í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ =====

function test_pv_connections() {
    print_header "1. PV ì—°ê²° í…ŒìŠ¤íŠ¸"
    
    local pvs=(
        "$THRESHOLD_PV"
        "$HYSTERESIS_PV"
        "$CURRENT_VALUE_PV"
        "$OUTPUT_STATE_PV"
        "$ENABLE_PV"
        "$UPDATE_RATE_PV"
        "$ALARM_STATE_PV"
        "$AO_PV"
    )
    
    local failed=0
    for pv in "${pvs[@]}"; do
        if ! check_pv_connection "$pv"; then
            ((failed++))
        fi
    done
    
    if [ $failed -eq 0 ]; then
        print_success "ëª¨ë“  PV ì—°ê²° ì„±ê³µ!"
    else
        print_error "$failed ê°œì˜ PV ì—°ê²° ì‹¤íŒ¨"
        echo "IOCê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
        exit 1
    fi
}

function test_initial_setup() {
    print_header "2. ì´ˆê¸° ì„¤ì • í…ŒìŠ¤íŠ¸"
    
    print_section "ê¸°ë³¸ ì„¤ì •ê°’ í™•ì¸"
    echo "ì„ê³„ê°’: $(get_pv_value $THRESHOLD_PV) V"
    echo "íˆìŠ¤í…Œë¦¬ì‹œìŠ¤: $(get_pv_value $HYSTERESIS_PV) V"
    echo "ì—…ë°ì´íŠ¸ ì£¼ê¸°: $(get_pv_value $UPDATE_RATE_PV) Hz"
    echo "í™œì„±í™” ìƒíƒœ: $(get_pv_value $ENABLE_PV)"
    echo "í˜„ì¬ê°’: $(get_pv_value $CURRENT_VALUE_PV) V"
    echo "ì¶œë ¥ ìƒíƒœ: $(get_pv_value $OUTPUT_STATE_PV)"
    
    print_section "í…ŒìŠ¤íŠ¸ìš© ì„¤ì • ì ìš©"
    set_pv_value "$THRESHOLD_PV" "2.5"
    set_pv_value "$HYSTERESIS_PV" "0.2"
    set_pv_value "$UPDATE_RATE_PV" "10.0"
    
    sleep 1
    
    print_success "í…ŒìŠ¤íŠ¸ ì„¤ì • ì™„ë£Œ:"
    echo "  - ì„ê³„ê°’: 2.5V"
    echo "  - íˆìŠ¤í…Œë¦¬ì‹œìŠ¤: 0.2V"
    echo "  - ì—…ë°ì´íŠ¸ ì£¼ê¸°: 10Hz"
}

function test_enable_disable() {
    print_header "3. í™œì„±í™”/ë¹„í™œì„±í™” í…ŒìŠ¤íŠ¸"
    
    print_section "ì»¨íŠ¸ë¡¤ëŸ¬ ë¹„í™œì„±í™”"
    set_pv_value "$ENABLE_PV" "0"
    sleep 1
    local enable_state=$(get_pv_value $ENABLE_PV)
    if [ "$enable_state" = "0" ]; then
        print_success "ë¹„í™œì„±í™” ì„±ê³µ"
    else
        print_error "ë¹„í™œì„±í™” ì‹¤íŒ¨"
    fi
    
    print_section "ì»¨íŠ¸ë¡¤ëŸ¬ í™œì„±í™”"
    set_pv_value "$ENABLE_PV" "1"
    sleep 2
    enable_state=$(get_pv_value $ENABLE_PV)
    if [ "$enable_state" = "1" ]; then
        print_success "í™œì„±í™” ì„±ê³µ"
    else
        print_error "í™œì„±í™” ì‹¤íŒ¨"
    fi
    
    print_info "í™œì„±í™” í›„ í˜„ì¬ ìƒíƒœ:"
    echo "  - í˜„ì¬ê°’: $(get_pv_value $CURRENT_VALUE_PV) V"
    echo "  - ì¶œë ¥ ìƒíƒœ: $(get_pv_value $OUTPUT_STATE_PV)"
}

function test_threshold_logic() {
    print_header "4. ì„ê³„ê°’ ë¡œì§ í…ŒìŠ¤íŠ¸"
    
    # ì»¨íŠ¸ë¡¤ëŸ¬ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    if [ "$(get_pv_value $ENABLE_PV)" != "1" ]; then
        print_info "ì»¨íŠ¸ë¡¤ëŸ¬ í™œì„±í™” ì¤‘..."
        set_pv_value "$ENABLE_PV" "1"
        sleep 2
    fi
    
    local test_voltages=(0.0 1.0 2.0 2.5 3.0 4.0 3.0 2.3 2.0 1.0 0.0)
    
    print_section "ì„ê³„ê°’ ë¡œì§ í…ŒìŠ¤íŠ¸ ì‹œì‘"
    print_info "ì„ê³„ê°’: 2.5V, íˆìŠ¤í…Œë¦¬ì‹œìŠ¤: 0.2V"
    print_info "ì˜ˆìƒ ë™ì‘:"
    print_info "  - ì…ë ¥ > 2.5V â†’ ì¶œë ¥ HIGH"
    print_info "  - ì…ë ¥ < 2.3V (2.5-0.2) â†’ ì¶œë ¥ LOW"
    echo
    
    for voltage in "${test_voltages[@]}"; do
        print_section "í…ŒìŠ¤íŠ¸ ì „ì••: ${voltage}V"
        
        # ì•„ë‚ ë¡œê·¸ ì¶œë ¥ìœ¼ë¡œ ì…ë ¥ ì‹œë®¬ë ˆì´ì…˜
        set_pv_value "$AO_PV" "$voltage"
        sleep 3
        
        # í˜„ì¬ ìƒíƒœ í™•ì¸
        local current_val=$(get_pv_value $CURRENT_VALUE_PV)
        local output_state=$(get_pv_value $OUTPUT_STATE_PV)
        local output_text="LOW"
        if [ "$output_state" = "1" ]; then
            output_text="HIGH"
        fi
        
        echo "  ì„¤ì •ê°’: ${voltage}V â†’ ì¸¡ì •ê°’: ${current_val}V â†’ ì¶œë ¥: ${output_text}"
        
        # ë¡œì§ ê²€ì¦
        if (( $(echo "$voltage > 2.5" | bc -l) )); then
            if [ "$output_state" = "1" ]; then
                print_success "  ë¡œì§ ì •ìƒ: ì„ê³„ê°’ ì´ˆê³¼ â†’ HIGH"
            else
                print_error "  ë¡œì§ ì˜¤ë¥˜: ì„ê³„ê°’ ì´ˆê³¼í–ˆì§€ë§Œ LOW"
            fi
        elif (( $(echo "$voltage < 2.3" | bc -l) )); then
            if [ "$output_state" = "0" ]; then
                print_success "  ë¡œì§ ì •ìƒ: íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ ë¯¸ë§Œ â†’ LOW"
            else
                print_error "  ë¡œì§ ì˜¤ë¥˜: íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ ë¯¸ë§Œì´ì§€ë§Œ HIGH"
            fi
        else
            print_info "  íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ êµ¬ê°„: ì´ì „ ìƒíƒœ ìœ ì§€"
        fi
        
        sleep 1
    done
}

function test_hysteresis() {
    print_header "5. íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"
    
    print_section "íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ í…ŒìŠ¤íŠ¸ ì¤€ë¹„"
    set_pv_value "$THRESHOLD_PV" "3.0"
    set_pv_value "$HYSTERESIS_PV" "0.5"
    sleep 1
    
    print_info "ì„¤ì •: ì„ê³„ê°’=3.0V, íˆìŠ¤í…Œë¦¬ì‹œìŠ¤=0.5V"
    print_info "ì˜ˆìƒ ë™ì‘: 3.0Vì—ì„œ HIGH, 2.5Vì—ì„œ LOW"
    
    # íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ í…ŒìŠ¤íŠ¸ ì‹œí€€ìŠ¤
    local hyst_voltages=(0.0 2.0 2.8 3.2 2.8 2.3 3.5 2.0)
    
    for voltage in "${hyst_voltages[@]}"; do
        print_section "íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ í…ŒìŠ¤íŠ¸: ${voltage}V"
        set_pv_value "$AO_PV" "$voltage"
        sleep 3
        
        local current_val=$(get_pv_value $CURRENT_VALUE_PV)
        local output_state=$(get_pv_value $OUTPUT_STATE_PV)
        local output_text="LOW"
        if [ "$output_state" = "1" ]; then
            output_text="HIGH"
        fi
        
        echo "  ${voltage}V â†’ ì¸¡ì •: ${current_val}V â†’ ì¶œë ¥: ${output_text}"
        sleep 1
    done
    
    # ì›ë˜ ì„¤ì •ìœ¼ë¡œ ë³µì›
    set_pv_value "$THRESHOLD_PV" "2.5"
    set_pv_value "$HYSTERESIS_PV" "0.2"
}

function test_update_rate() {
    print_header "6. ì—…ë°ì´íŠ¸ ì£¼ê¸° í…ŒìŠ¤íŠ¸"
    
    local rates=(1.0 5.0 20.0 10.0)
    
    for rate in "${rates[@]}"; do
        print_section "ì—…ë°ì´íŠ¸ ì£¼ê¸°: ${rate}Hz"
        set_pv_value "$UPDATE_RATE_PV" "$rate"
        sleep 1
        
        local actual_rate=$(get_pv_value $UPDATE_RATE_PV)
        echo "  ì„¤ì •: ${rate}Hz â†’ ì‹¤ì œ: ${actual_rate}Hz"
        
        print_info "5ì´ˆê°„ ëª¨ë‹ˆí„°ë§..."
        monitor_pvs 5
    done
}

function test_alarm_conditions() {
    print_header "7. ì•ŒëŒ ì¡°ê±´ í…ŒìŠ¤íŠ¸"
    
    print_section "ì •ìƒ ë²”ìœ„ í…ŒìŠ¤íŠ¸"
    set_pv_value "$AO_PV" "2.0"
    sleep 3
    echo "ì•ŒëŒ ìƒíƒœ: $(get_pv_value $ALARM_STATE_PV)"
    
    print_section "ë²”ìœ„ ì´ˆê³¼ í…ŒìŠ¤íŠ¸"
    set_pv_value "$AO_PV" "9.5"
    sleep 3
    echo "ì•ŒëŒ ìƒíƒœ: $(get_pv_value $ALARM_STATE_PV)"
    
    # ì •ìƒ ë²”ìœ„ë¡œ ë³µì›
    set_pv_value "$AO_PV" "2.0"
    sleep 2
}

function test_reset_function() {
    print_header "8. ë¦¬ì…‹ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"
    
    print_section "ë¦¬ì…‹ ëª…ë ¹ ì „ì†¡"
    if check_pv_connection "$RESET_PV"; then
        set_pv_value "$RESET_PV" "1"
        sleep 2
        print_success "ë¦¬ì…‹ ëª…ë ¹ ì „ì†¡ ì™„ë£Œ"
        
        print_info "ë¦¬ì…‹ í›„ ìƒíƒœ:"
        echo "  - í˜„ì¬ê°’: $(get_pv_value $CURRENT_VALUE_PV) V"
        echo "  - ì¶œë ¥ ìƒíƒœ: $(get_pv_value $OUTPUT_STATE_PV)"
        echo "  - ì•ŒëŒ ìƒíƒœ: $(get_pv_value $ALARM_STATE_PV)"
    else
        print_error "ë¦¬ì…‹ PVë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
    fi
}

function test_continuous_monitoring() {
    print_header "9. ì—°ì† ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸"
    
    print_section "ì‚¬ì¸íŒŒ ì…ë ¥ìœ¼ë¡œ ì—°ì† í…ŒìŠ¤íŠ¸"
    print_info "30ì´ˆê°„ ì‚¬ì¸íŒŒ ì…ë ¥ì„ ìƒì„±í•˜ì—¬ ThresholdLogic ë™ì‘ì„ í™•ì¸í•©ë‹ˆë‹¤"
    print_info "ì„ê³„ê°’: 2.5V, ì§„í­: 4V (0V ~ 4V)"
    
    # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ëª¨ë‹ˆí„°ë§ ì‹œì‘
    timeout 35 camonitor "$CURRENT_VALUE_PV" "$OUTPUT_STATE_PV" > /tmp/threshold_monitor.log 2>&1 &
    local monitor_pid=$!
    
    # ì‚¬ì¸íŒŒ ìƒì„± (30ì´ˆ, 0.5Hz)
    local samples=60
    local duration=30
    local amplitude=2.0
    local offset=2.0
    
    for ((i = 0; i < samples; i++)); do
        local t=$(echo "$i * $duration / $samples" | bc -l)
        local theta=$(echo "2 * 3.141592 * 0.5 * $t" | bc -l)
        local sin_val=$(python3 -c "import math; print(math.sin($theta))" 2>/dev/null || echo "0")
        local voltage=$(echo "$offset + $amplitude * $sin_val" | bc -l)
        
        set_pv_value "$AO_PV" "$voltage"
        printf "ì‹œê°„: %2ds, ì…ë ¥: %.2fV\r" "$((i/2))" "$voltage"
        sleep 0.5
    done
    
    echo
    wait $monitor_pid 2>/dev/null || true
    
    print_success "ì—°ì† ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
    if [ -f /tmp/threshold_monitor.log ]; then
        local transitions=$(grep -c "High\|Low" /tmp/threshold_monitor.log 2>/dev/null || echo "0")
        print_info "ì¶œë ¥ ìƒíƒœ ë³€í™” íšŸìˆ˜: $transitions"
        rm -f /tmp/threshold_monitor.log
    fi
}

function test_performance() {
    print_header "10. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸"
    
    print_section "ë¹ ë¥¸ ë³€í™” í…ŒìŠ¤íŠ¸"
    set_pv_value "$UPDATE_RATE_PV" "50.0"
    sleep 1
    
    print_info "ë¹ ë¥¸ ì „ì•• ë³€í™”ë¡œ ì‘ë‹µì„± í…ŒìŠ¤íŠ¸ (50Hz ì—…ë°ì´íŠ¸)"
    local fast_voltages=(1.0 3.0 1.0 3.0 1.0 3.0 1.0 3.0)
    
    for voltage in "${fast_voltages[@]}"; do
        set_pv_value "$AO_PV" "$voltage"
        sleep 0.2
        local output=$(get_pv_value $OUTPUT_STATE_PV)
        printf "%.1fV â†’ %s  " "$voltage" "$output"
    done
    echo
    
    # ì›ë˜ ì„¤ì •ìœ¼ë¡œ ë³µì›
    set_pv_value "$UPDATE_RATE_PV" "10.0"
    set_pv_value "$AO_PV" "0.0"
}

function generate_test_report() {
    print_header "í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½"
    
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local report_file="/tmp/threshold_logic_test_report.txt"
    
    {
        echo "ThresholdLogic Controller í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ"
        echo "ìƒì„± ì‹œê°„: $timestamp"
        echo "========================================"
        echo
        echo "ìµœì¢… ì„¤ì • ìƒíƒœ:"
        echo "  ì„ê³„ê°’: $(get_pv_value $THRESHOLD_PV) V"
        echo "  íˆìŠ¤í…Œë¦¬ì‹œìŠ¤: $(get_pv_value $HYSTERESIS_PV) V"
        echo "  ì—…ë°ì´íŠ¸ ì£¼ê¸°: $(get_pv_value $UPDATE_RATE_PV) Hz"
        echo "  í™œì„±í™” ìƒíƒœ: $(get_pv_value $ENABLE_PV)"
        echo
        echo "ìµœì¢… ë™ì‘ ìƒíƒœ:"
        echo "  í˜„ì¬ê°’: $(get_pv_value $CURRENT_VALUE_PV) V"
        echo "  ì¶œë ¥ ìƒíƒœ: $(get_pv_value $OUTPUT_STATE_PV)"
        echo "  ì•ŒëŒ ìƒíƒœ: $(get_pv_value $ALARM_STATE_PV)"
        echo
        echo "í…ŒìŠ¤íŠ¸ ì™„ë£Œ í•­ëª©:"
        echo "  âœ“ PV ì—°ê²° í…ŒìŠ¤íŠ¸"
        echo "  âœ“ ì´ˆê¸° ì„¤ì • í…ŒìŠ¤íŠ¸"
        echo "  âœ“ í™œì„±í™”/ë¹„í™œì„±í™” í…ŒìŠ¤íŠ¸"
        echo "  âœ“ ì„ê³„ê°’ ë¡œì§ í…ŒìŠ¤íŠ¸"
        echo "  âœ“ íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"
        echo "  âœ“ ì—…ë°ì´íŠ¸ ì£¼ê¸° í…ŒìŠ¤íŠ¸"
        echo "  âœ“ ì•ŒëŒ ì¡°ê±´ í…ŒìŠ¤íŠ¸"
        echo "  âœ“ ì—°ì† ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸"
        echo "  âœ“ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸"
    } > "$report_file"
    
    cat "$report_file"
    print_success "í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: $report_file"
}

function cleanup() {
    print_header "ì •ë¦¬ ì‘ì—…"
    
    print_section "ì„¤ì • ì´ˆê¸°í™”"
    set_pv_value "$AO_PV" "0.0"
    set_pv_value "$THRESHOLD_PV" "2.5"
    set_pv_value "$HYSTERESIS_PV" "0.1"
    set_pv_value "$UPDATE_RATE_PV" "10.0"
    set_pv_value "$ENABLE_PV" "0"
    
    print_success "ì •ë¦¬ ì‘ì—… ì™„ë£Œ"
}

# ===== ë©”ì¸ í•¨ìˆ˜ =====

function show_menu() {
    echo -e "\n${CYAN}ThresholdLogic Controller í…ŒìŠ¤íŠ¸ ë©”ë‰´${NC}"
    echo "1) ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
    echo "2) PV ì—°ê²° í…ŒìŠ¤íŠ¸ë§Œ"
    echo "3) ì„ê³„ê°’ ë¡œì§ í…ŒìŠ¤íŠ¸ë§Œ"
    echo "4) íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ í…ŒìŠ¤íŠ¸ë§Œ"
    echo "5) ì—°ì† ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸ë§Œ"
    echo "6) ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (Ctrl+Cë¡œ ì¤‘ì§€)"
    echo "7) í˜„ì¬ ìƒíƒœ í™•ì¸"
    echo "8) ì„¤ì • ì´ˆê¸°í™”"
    echo "9) ì¢…ë£Œ"
    echo -n "ì„ íƒí•˜ì„¸ìš” (1-9): "
}

function interactive_mode() {
    while true; do
        show_menu
        read choice
        
        case $choice in
            1)
                run_all_tests
                ;;
            2)
                test_pv_connections
                ;;
            3)
                test_threshold_logic
                ;;
            4)
                test_hysteresis
                ;;
            5)
                test_continuous_monitoring
                ;;
            6)
                print_info "ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (Ctrl+Cë¡œ ì¤‘ì§€)..."
                camonitor "$CURRENT_VALUE_PV" "$OUTPUT_STATE_PV" "$THRESHOLD_PV" "$ENABLE_PV"
                ;;
            7)
                print_header "í˜„ì¬ ìƒíƒœ"
                echo "ì„ê³„ê°’: $(get_pv_value $THRESHOLD_PV) V"
                echo "íˆìŠ¤í…Œë¦¬ì‹œìŠ¤: $(get_pv_value $HYSTERESIS_PV) V"
                echo "í˜„ì¬ê°’: $(get_pv_value $CURRENT_VALUE_PV) V"
                echo "ì¶œë ¥ ìƒíƒœ: $(get_pv_value $OUTPUT_STATE_PV)"
                echo "í™œì„±í™” ìƒíƒœ: $(get_pv_value $ENABLE_PV)"
                echo "ì—…ë°ì´íŠ¸ ì£¼ê¸°: $(get_pv_value $UPDATE_RATE_PV) Hz"
                ;;
            8)
                cleanup
                ;;
            9)
                print_info "í…ŒìŠ¤íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
                exit 0
                ;;
            *)
                print_error "ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤."
                ;;
        esac
        
        wait_for_user
    done
}

function run_all_tests() {
    print_header "ThresholdLogic Controller ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œì‘"
    
    test_pv_connections
    test_initial_setup
    test_enable_disable
    test_threshold_logic
    test_hysteresis
    test_update_rate
    test_alarm_conditions
    test_reset_function
    test_continuous_monitoring
    test_performance
    generate_test_report
    cleanup
    
    print_header "ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
}

# ===== ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ =====

function main() {
    print_header "ThresholdLogic Controller í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸"
    print_info "ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ThresholdLogicControllerì˜ ëª¨ë“  ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤."
    print_info "IOCê°€ ì‹¤í–‰ ì¤‘ì´ê³  ThresholdLogicì´ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
    echo
    
    # ëª…ë ¹í–‰ ì¸ìˆ˜ í™•ì¸
    if [ "$1" = "--auto" ] || [ "$1" = "-a" ]; then
        print_info "ìë™ ëª¨ë“œë¡œ ì „ì²´ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
        run_all_tests
    else
        print_info "ëŒ€í™”í˜• ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤..."
        interactive_mode
    fi
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main "$@"










ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/catest_USB1608G_2AO.sh
=================================================
#!/bin/bash

# ===== í•¨ìˆ˜ ì •ì˜ =====

function set_automode() {
  echo "==========[ ì´ˆê¸°í™”: AutoMode ON ]=========="
  caput USB1608G_2AO:AiMode 1
  for i in {5..8}; do
    caput USB1608G_2AO:Threshold:Ai1-Bo$i:AutoMode 1
  done
  sleep 2
}



function set_voltage_and_read() {
  local voltage=$1
  echo ""
  echo "--------- Ao1 = ${voltage}V"
  caput USB1608G_2AO:Ao1 "$voltage"
  sleep 3
  caget USB1608G_2AO:Ai1
  for i in {5..8}; do
    caget USB1608G_2AO:Threshold:Ai1-Bo$i:Calc
  done
  for i in {5..8}; do
    caget USB1608G_2AO:Bo$i
  done
}



function manual_calc_test() {
  echo ""
  echo "==========[ CALCì— ê³ ì •ê°’ìœ¼ë¡œ ì§ì ‘ ë„£ì–´ì„œ í™•ì¸ ]=========="

  # CALC, OUT í•„ë“œ ìˆ˜ë™ ì„¤ì •
  caput USB1608G_2AO:Threshold:Ai1-Bo6:Calc.CALC "B?(A>=2):C"
  caput USB1608G_2AO:Threshold:Ai1-Bo6:Calc.OUT "USB1608G_2AO:Bo6 PP"

  # í…ŒìŠ¤íŠ¸ ì „ì•• ì„¤ì •
  caput -t USB1608G_2AO:Ao1 2.5
  sleep 3
  caget USB1608G_2AO:Ai1

  # PROC ê°•ì œ ì‹¤í–‰
  caput USB1608G_2AO:Threshold:Ai1-Bo6:Calc.PROC 1

  # ê²°ê³¼ í™•ì¸
  caget USB1608G_2AO:Threshold:Ai1-Bo6:Calc
  caget USB1608G_2AO:Bo5
  caget USB1608G_2AO:Bo6

  # ë‹¤ì‹œ 0Vë¡œ ì„¤ì •
  caput -t USB1608G_2AO:Ao1 0
  sleep 3
  caget USB1608G_2AO:Ai1
}





# í˜•ì‹: sine_wave_ao1 <ì§„í­> <ì£¼íŒŒìˆ˜> <ìƒ˜í”Œìˆ˜> <ì§€ì—°ì‹œê°„>
# ì˜ˆì‹œ: sine_wave_ao1 5 1 100 0.1   â†’ 5V ì‚¬ì¸íŒŒ, 1Hz, 100í¬ì¸íŠ¸, 0.1ì´ˆ ê°„ê²© ì¶œë ¥

function sine_wave_ao1() {
  local amplitude=$1   # ìµœëŒ€ ì „ì•• (ì˜ˆ: 5V)
  local samples=$2     # ì „ì²´ ìƒ˜í”Œ ìˆ˜
  local duration=$3    # ì „ì²´ ì‹œê°„ (ì´ˆ)

  # delay = duration / samples
  local delay=$(echo "scale=6; $duration / $samples" | bc -l)

  # frequency = 1 / duration
  local freq=$(echo "scale=6; 1 / $duration" | bc -l)

  echo "===== Ao1ì— Sine Wave ì¶œë ¥ ì‹œì‘ ====="
  echo "ì§„í­=${amplitude}V, ìƒ˜í”Œìˆ˜=${samples}, ì „ì²´ì‹œê°„=${duration}s, ì£¼ê¸°=${freq}Hz, delay=${delay}s"

  for ((i = 0; i < samples; i++)); do
    # ì‹œê°„ t
    t=$(echo "$i * $delay" | bc -l)

    # ê°ë„ theta = 2Ï€ft
    theta=$(echo "2 * 3.141592 * $freq * $t" | bc -l)

    # ì‚¬ì¸ê°’ ê³„ì‚°
    sin_val=$(python3 -c "import math; print(math.sin($theta))")

    # ì „ì•• = A * sin(theta)
    voltage=$(echo "$amplitude * $sin_val" | bc -l)

    # ì¶œë ¥
    printf "[%03d] Ao1 = %.3f V\n" "$i" "$voltage"
    caput -t USB1608G_2AO:Ao1 "$voltage"

    sleep "$delay"
  done

  echo "===== Sine Wave ì¶œë ¥ ì¢…ë£Œ ====="
}














# ===== main í•¨ìˆ˜ ì •ì˜ =====

function main() {
  set_automode

  local voltages=(0.0 1.11 2.22 3.33 4.44 3.33 2.22 1.11 0.0)

  for v in "${voltages[@]}"; do
    set_voltage_and_read "$v"
  done

  # manual_calc_test
  
  # ì§„í­ 5V, 100 ìƒ˜í”Œ, 50ì´ˆ ë™ì•ˆ ì‚¬ì¸íŒŒ 1ì£¼ê¸° ì¶œë ¥
  sine_wave_ao1 5 100 30

}

# ===== ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘ =====
main











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/cleanup_USB1608G_2AO.sh
=================================================
#!/bin/bash

# EPICS ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” íŒŒì¼ ë° ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ë¥¼ ì •ë¦¬í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸

# í•¨ìˆ˜: ì§€ì •ëœ íŒ¨í„´ì˜ íŒŒì¼/ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì•„ ì‚­ì œë¥¼ í™•ì¸í•˜ê³  ì‹¤í–‰
# ì‚¬ìš©ë²•: cleanup_items "ì„¤ëª…" <find ëª…ë ¹ì–´ ì¸ìë“¤>
cleanup_items() {
    local description="$1"
    shift
    local find_args=("$@")

    echo "--- $description ê²€ìƒ‰ ì¤‘..."
    # find ëª…ë ¹ì„ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ ë°°ì—´ì— ì €ì¥
    # -print0ê³¼ read -d ''ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µë°±ì´ í¬í•¨ëœ íŒŒì¼ ì´ë¦„ ì²˜ë¦¬
    local items_to_delete=()
    while IFS= read -r -d $'\0'; do
        items_to_delete+=("$REPLY")
    done < <(find . -depth "${find_args[@]}" -print0 2>/dev/null)


    if [ ${#items_to_delete[@]} -eq 0 ]; then
        echo " -> ì‚­ì œí•  í•­ëª© ì—†ìŒ."
        echo ""
        return
    fi

    echo " -> ë‹¤ìŒ í•­ëª©ë“¤ì„ ì‚­ì œí• ê¹Œìš”?"
    printf '    - %s\n' "${items_to_delete[@]}"

    read -p "   ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " confirm
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        # ë°°ì—´ì˜ ê° í•­ëª©ì— ëŒ€í•´ rm -rf ì‹¤í–‰
        for item in "${items_to_delete[@]}"; do
            if [ -e "$item" ]; then # í•­ëª©ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                echo "    -> ì‚­ì œ ì¤‘: $item"
                rm -rf "$item"
            fi
        done
        echo " -> ì™„ë£Œ."
    else
        echo " -> ì‚­ì œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
    fi
    echo ""
}

# ë©”ì¸ ì •ë¦¬ í•¨ìˆ˜
main_cleanup() {
    echo "================================================="
    echo "EPICS ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸"
    echo "================================================="
    echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
    echo ""

    # 1. ë¹Œë“œ ì¶œë ¥ ë””ë ‰í† ë¦¬ (O.*)
    cleanup_items "ë¹Œë“œ ì¶œë ¥ ë””ë ‰í† ë¦¬ (O.*)" -type d -name "O.*"

    # 2. ë°±ì—… íŒŒì¼ (*.bak, *_BAK.adl)
    cleanup_items "ë°±ì—… íŒŒì¼ (*.bak, *_BAK.adl)" -type f \( -name "*.bak" -o -name "*_BAK.adl" \)

    # 3. EPICS autosave ë°±ì—… íŒŒì¼ (*.sav[0-9], *.savB)
    cleanup_items "EPICS autosave ë°±ì—… íŒŒì¼" -type f \( -name "*.sav[0-9]" -o -name "*.savB" \)

    # 4. ì»´íŒŒì¼ëœ ì‹¤í–‰ íŒŒì¼ (bin/*)
    cleanup_items "ì»´íŒŒì¼ëœ ì‹¤í–‰ íŒŒì¼" -path "./bin/*" -type f

    # 5. ì´ IOCì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë‹¤ë¥¸ ëª¨ë¸ìš© ì„¤ì • íŒŒì¼ (*_settings.req)
    cleanup_items "ë‹¤ë¥¸ ëª¨ë¸ìš© ì„¤ì • íŒŒì¼" -type f -name "*_settings.req" \
        -not -name "measComp*" \
        -not -name "USB1608G_2AO_settings.req"

    echo "================================================="
    echo "ì •ë¦¬ ì™„ë£Œ."
    echo "================================================="
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main_cleanup











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/envPaths
=================================================
epicsEnvSet("IOC","iocUSB1608G_2AO_V2")
epicsEnvSet("TOP","/usr/local/epics/EPICS_R7.0/siteApp/USB1608G_2AO_V2")
epicsEnvSet("EPICS_BASE","/usr/local/epics/EPICS_R7.0/base")
epicsEnvSet("SUPPORT","/usr/local/epics/EPICS_R7.0/modules/synApps/support")
epicsEnvSet("ASYN","/usr/local/epics/EPICS_R7.0/modules/synApps/support/asyn-R4-44-2")
epicsEnvSet("CALC","/usr/local/epics/EPICS_R7.0/modules/synApps/support/calc-R3-7-5")
epicsEnvSet("SCALER","/usr/local/epics/EPICS_R7.0/modules/synApps/support/scaler-4-1")
epicsEnvSet("MCA","/usr/local/epics/EPICS_R7.0/modules/synApps/support/mca-R7-10")
epicsEnvSet("BUSY","/usr/local/epics/EPICS_R7.0/modules/synApps/support/busy-R1-7-4")
epicsEnvSet("SSCAN","/usr/local/epics/EPICS_R7.0/modules/synApps/support/sscan-R2-11-6")
epicsEnvSet("AUTOSAVE","/usr/local/epics/EPICS_R7.0/modules/synApps/support/autosave-R5-11")
epicsEnvSet("SNCSEQ","/usr/local/epics/EPICS_R7.0/modules/synApps/support/sequencer-mirror-R2-2-9")
epicsEnvSet("MEASCOMP","/usr/local/epics/EPICS_R7.0/modules/synApps/support/measComp-R4-2")











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/medm_USB1608G_2AO.sh
=================================================
#!/bin/bash

# ========== Logging ==========
LOG_DIR="/root/log"
script_name="${0##*/}";
script_name="${script_name%.*}"
LOG_FILE="$LOG_DIR/$script_name.log"

APPNAME="USB1608G_2AO_V2"

init_log() {
    mkdir -p "$LOG_DIR"
    {
        echo "========================================="
        echo " Log File: $LOG_FILE"
        echo " Created: $(date '+%Y-%m-%d %H:%M:%S')"
        echo " User: $(whoami)"
        echo " Host: $(hostname)"
        echo "========================================="
    } > "$LOG_FILE"
}


export EPICS_SITE=${EPICS_PATH}/siteApp
# ========== Functions ==========
# /usr/local/epics/EPICS_R7.0/siteApp/USB1608G/USB1608GApp/op/USB1608G.adl

USB1608G_2AO_exec() {
    local OPDIR=${EPICS_SITE}/${APPNAME}/${APPNAME}App/op

    cd ${OPDIR}
    # args="P=USB1608G_2AO:,Bi=Bi,Li=Li,Bo=Bo,Lo=Lo,Bd=Bd,Ai=Ai,Ao=Ao,Ct=Counter,Wd=WaveDig,Wg=WaveGen,Pg=PulseGen,Tg=Trig"

    # Build macro string
    local MACRO_STR="P=USB1608G_2AO:,Bi=Bi,Li=Li,Bo=Bo,Lo=Lo,Bd=Bd,Ai=Ai,Ao=Ao,Ct=Counter,Wd=WaveDig,Wg=WaveGen,Pg=PulseGen,Tg=Trig"    

    # Call medm with explicit options, properly quoted. / ëª…ì‹œì  ì˜µì…˜ê³¼ ì˜¬ë°”ë¥¸ ë”°ì˜´í‘œ
    medm -x -macro "$MACRO_STR" -displayFont fixed "${APPNAME}.adl" &
    echo " - cd ${OPDIR}"
}

USB1608G_2AO_edit() {
    local OPDIR=${EPICS_SITE}/${APPNAME}/${APPNAME}App/op

    cd ${OPDIR}
    # args="P=USB1608G_2AO:,Bi=Bi,Li=Li,Bo=Bo,Lo=Lo,Bd=Bd,Ai=Ai,Ao=Ao,Ct=Counter,Wd=WaveDig,Wg=WaveGen,Pg=PulseGen,Tg=Trig"
    export MEDM_MACRO="-macro P=USB1608G_2AO:,Bi=Bi,Li=Li,Bo=Bo,Lo=Lo,Bd=Bd,Ai=Ai,Ao=Ao,Ct=Counter,Wd=WaveDig,Wg=WaveGen,Pg=PulseGen,Tg=Trig"
    export MEDM_FONT='-displayFont fixed'
    medm $MEDM_MACRO $MEDM_FONT ${APPNAME}.adl &
    echo " - cd ${OPDIR}"
}


measCompDigitalIO8_exec() {
    local OPDIR=${EPICS_SITE}/${APPNAME}/${APPNAME}App/op

    cd ${OPDIR}    
    export MEDM_MACRO="-macro P=USB1608G_2AO:,Bi=Bi,Li=Li,Bo=Bo,Lo=Lo,Bd=Bd"
    export MEDM_FONT='-displayFont fixed'
    medm -x $MEDM_MACRO $MEDM_FONT measCompDigitalIO8.adl &
    echo " - cd ${OPDIR}"
}

measCompDigitalIO8_edit() {
    local OPDIR=${EPICS_SITE}/${APPNAME}/${APPNAME}App/op

    cd ${OPDIR}    
    export MEDM_MACRO="-macro P=USB1608G_2AO:,Bi=Bi,Li=Li,Bo=Bo,Lo=Lo,Bd=Bd"
    export MEDM_FONT='-displayFont fixed'
    medm $MEDM_MACRO $MEDM_FONT measCompDigitalIO8.adl &
    echo " - cd ${OPDIR}"
}






# ========== Common function ==========
kill_medm() {
    echo "[INFO] Checking for existing medm processes..."

    local medm_pids
    medm_pids=$(pgrep -x medm)

    if [[ -z "$medm_pids" ]]; then
        printf "%7s%s\n" "" "- No medm process found. Nothing to kill."
    else
        printf "%7s%s\n" "" "- Found medm process(es): $medm_pids"
        printf "%7s%s\n" "" "- Killing medm process(es)..."
        kill $medm_pids
        sleep 0.5

        if pgrep -x medm >/dev/null; then
            printf "%7s%s\n" "" "- [WARN] Some medm process(es) may still be running."
        else
            printf "%7s%s\n" "" "- All medm process(es) terminated successfully."
        fi
    fi
}













# ========== Main ==========
handle_selection() {
	case "$1" in
			1) USB1608G_2AO_exec ;;
			2) USB1608G_2AO_edit ;;
            3) measCompDigitalIO8_exec ;;
            4) measCompDigitalIO8_edit ;;
			0)
					echo "Exit the script"
					return 0  # << exit ëŒ€ì‹  return
					;;
			*)
					echo ""
					echo "You have entered '${1}'"
					echo "Please select the number in the list..."
					echo "Exit the script"
					echo ""
					return 1
					;;
	esac

	echo -e "\n========================================"
	echo "[DONE] All tasks completed"
}


main() {
    #init_log
    #printf '\n%.0s' {1..3}
    kill_medm

    echo ""
    echo "Enter the number of you want to script"
    echo "1 : USB1608G_2AO_exec (with ThresholdLogic)"
    echo "2 : USB1608G_2AO_edit (with ThresholdLogic)"
    echo ""
    echo "3 : measCompDigitalIO8_exec"
    echo "4 : measCompDigitalIO8_edit"
    echo ""
    echo "0 : Exit script"
    echo -n "Enter the number : "
    read answer

    handle_selection "$answer"
    if [[ $? -ne 0 ]]; then
        exit 1
    fi
}
main












ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/save_restore.cmd
=================================================
# Debug-output level
save_restoreSet_Debug(0)

# Ok to save/restore save sets with missing values (no CA connection to PV)?
save_restoreSet_IncompleteSetsOk(1)
# Save dated backup files?
save_restoreSet_DatedBackupFiles(1)

# Number of sequenced backup files to write
save_restoreSet_NumSeqFiles(3)
# Time interval between sequenced backups
save_restoreSet_SeqPeriodInSeconds(300)

# specify where save files should be
set_savefile_path(".", "autosave")

# specify what save files should be restored.  Note these files must be
# in the directory specified in set_savefile_path(), or, if that function
# has not been called, from the directory current when iocInit is invoked0
set_pass0_restoreFile("auto_settings.sav")
set_pass1_restoreFile("auto_settings.sav")

# specify directories in which to to search for included request files
# Note cdCommands defines 'startup', but envPaths does not
set_requestfile_path(".",         "")
set_requestfile_path(".",         "autosave")
set_requestfile_path($(AUTOSAVE), "db")
set_requestfile_path($(CALC),     "db")
set_requestfile_path($(SCALER),   "db")
set_requestfile_path($(SSCAN),    "db")
set_requestfile_path($(MEASCOMP), "db")











ğŸ”¥ File: ./iocBoot/iocUSB1608G_2AO_V2/st.cmd
=================================================
#!../../bin/linux-x86_64/USB1608G_2AO_V2
< envPaths

## Register all support components
dbLoadDatabase("$(TOP)/dbd/USB1608G_2AO_V2.dbd")
USB1608G_2AO_V2_registerRecordDeviceDriver(pdbbase)

## Environment variable setup
epicsEnvSet("PREFIX", "USB1608G_2AO:")
epicsEnvSet("PORT", "USB1608G_2AO_PORT")
epicsEnvSet("WDIG_POINTS", "1048576")
epicsEnvSet("WGEN_POINTS", "1048576")
epicsEnvSet("UNIQUE_ID", "01D97CFA")

## Configure port driver
MultiFunctionConfig("$(PORT)", "$(UNIQUE_ID)", $(WDIG_POINTS), $(WGEN_POINTS))

## Configure threshold logic controller
epicsEnvSet("THRESHOLD_PORT", "THRESHOLD_LOGIC_PORT")
ThresholdLogicConfig("$(THRESHOLD_PORT)", "$(PORT)", 0)

## Load database templates
dbLoadTemplate("$(TOP)/USB1608G_2AO_V2App/Db/USB1608G_2AO.substitutions", "P=$(PREFIX),PORT=$(PORT),WDIG_POINTS=$(WDIG_POINTS),WGEN_POINTS=$(WGEN_POINTS)")

## Load save/restore configuration
< save_restore.cmd

## Initialize IOC
iocInit

## Setup autosave monitoring
create_monitor_set("auto_settings.req",30,"P=$(PREFIX)")

